<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>항생제 내성 시뮬레이터</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; margin: 40px; line-height: 1.6; }
  .story { background-color: #eef6ff; padding: 18px; border-left: 5px solid #3498db; margin-bottom: 20px; border-radius: 8px; }
  .box { border: 1px solid #ccc; padding: 16px; margin-bottom: 20px; border-radius: 8px; background: #f9f9f9; }
  .timer { font-weight: bold; font-size: 18px; color: red; margin-top:10px; }
  button { margin-top: 10px; padding: 6px 14px; font-size: 15px; cursor: pointer; }
  .overlay {
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000;
  }
  .popup { background:#fff; padding:20px; border-radius:10px; text-align:center; width:300px; }
  .popup button { margin-top: 15px; }
  .progress-container {
    width: 100%; background: #ddd; border-radius: 8px; overflow: hidden; margin-top: 10px;
    height: 20px;
  }
  .progress-bar {
    height: 100%; width: 100%; background: green; transition: width 0.5s ease, background 0.5s ease;
  }
  .answer-correct { color: green; font-weight: bold; }
  .answer-wrong { color: red; font-weight: bold; }
</style>
</head>
<body>

<h1>🧬 살아남는 자들의 법칙 - 항생제 내성 시뮬레이터</h1>

<div class="story">
  <strong>문제:</strong><br>
  항생제를 투여했을 때 살아남을 수 있는 세균을 찾는 미션입니다.<br>
  난이도가 높아질수록 세균 수, 유전자 종류, 항생제 종류, 필요 유전자 개수가 늘어납니다.
</div>

<div class="box">
  <label>난이도:
    <select id="difficultySelect" onchange="updateDifficultyInfo()">
      <option value="easy">쉬움</option>
      <option value="medium">보통</option>
      <option value="hard">어려움</option>
    </select>
  </label>
  <p id="difficultyInfo" style="font-style: italic; color: #555;"></p>
  
  <label>시간 설정:
    <select id="timeSelect">
      <option value="30">30초</option>
      <option value="60">1분</option>
      <option value="90">1분 30초</option>
      <option value="120">2분</option>
    </select>
  </label>
  <button onclick="startChallenge()">문제 풀기</button>
  <div class="timer" id="timerDisplay"></div>
  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>
</div>

<div id="challengeArea" style="display:none;">
  <div class="box">
    <p><strong>항생제 조건:</strong></p>
    <div id="antibioticList"></div>
  </div>

  <div class="box">
    <p><strong>세균 목록:</strong></p>
    <ul id="bacteriaListUI"></ul>
  </div>

  <div class="box">
    <p><strong>정답 입력:</strong></p>
    <input type="text" id="userAnswer" placeholder="예: 1,3,5">
    <button onclick="checkAnswer()">정답 확인</button>
    <p id="answerResult"></p>
    <div id="retryButtonArea"></div>
  </div>

  <div class="result" id="result"></div>
</div>

<div class="overlay" id="popupOverlay">
  <div class="popup">
    <h2>⏰ 시간 초과!</h2>
    <p>다시 도전하시겠습니까?</p>
    <button onclick="restartChallenge()">다시 도전하기</button>
  </div>
</div>

<script>
let countdown;
let remainingTime;
let totalTime;
let correctSurvivors = [];
let antibioticsData = {};

const difficultySettings = {
  easy: { count: 5, genes: ['R1','R2','R3','R4'], antibiotics: 2, genesPerAntibiotic: [1,1], info: "세균 5마리, 항생제 2종, 각 항생제당 1개 유전자 필요" },
  medium: { count: 7, genes: ['R1','R2','R3','R4','R5'], antibiotics: 3, genesPerAntibiotic: [1,2], info: "세균 7마리, 항생제 3종, 각 항생제당 1~2개 유전자 필요" },
  hard: { count: 10, genes: ['R1','R2','R3','R4','R5','R6','R7'], antibiotics: 4, genesPerAntibiotic: [2,3], info: "세균 10마리, 항생제 4종, 각 항생제당 2~3개 유전자 필요" }
};

function updateDifficultyInfo() {
  const difficulty = document.getElementById('difficultySelect').value;
  document.getElementById('difficultyInfo').innerText = difficultySettings[difficulty].info;
}

function randomGenes(pool, range) {
  const count = Math.floor(Math.random()*(range[1]-range[0]+1)) + range[0];
  const shuffled = [...pool].sort(() => 0.5 - Math.random());
  return shuffled.slice(0,count);
}

function generateAntibiotics(difficulty) {
  const { antibiotics, genes, genesPerAntibiotic } = difficultySettings[difficulty];
  const antibioticList = document.getElementById('antibioticList');
  antibioticList.innerHTML = '';
  antibioticsData = {};

  const names = ['A','B','C','D'];
  for (let i=0; i<antibiotics; i++) {
    const reqGenes = randomGenes(genes, genesPerAntibiotic);
    antibioticsData[names[i]] = reqGenes;
    const p = document.createElement('p');
    p.textContent = `항생제 ${names[i]} 필요 유전자: ${reqGenes.join(', ')}`;
    antibioticList.appendChild(p);
  }
}

function generateRandomBacteriaList(count, genesPool) {
  const bacteriaList = document.getElementById('bacteriaListUI');
  bacteriaList.innerHTML = '';
  for (let i = 1; i <= count; i++) {
    const numGenes = Math.floor(Math.random() * 2) + 2;
    const shuffled = [...genesPool].sort(() => 0.5 - Math.random());
    const selectedGenes = shuffled.slice(0, numGenes);
    const li = document.createElement('li');
    li.textContent = `세균 ${i}: [${selectedGenes.join(', ')}]`;
    bacteriaList.appendChild(li);
  }
}

function startChallenge() {
  const difficulty = document.getElementById('difficultySelect').value;
  const { count, genes } = difficultySettings[difficulty];
  
  totalTime = parseInt(document.getElementById('timeSelect').value);
  remainingTime = totalTime;
  
  generateAntibiotics(difficulty);
  generateRandomBacteriaList(count, genes);
  calculateCorrectSurvivors();

  document.getElementById('timerDisplay').innerText = `남은 시간: ${remainingTime}초`;
  document.getElementById('challengeArea').style.display = 'block';
  document.getElementById('progressBar').style.width = "100%";
  document.getElementById('progressBar').style.background = "green";
  document.getElementById('retryButtonArea').innerHTML = '';

  clearInterval(countdown);
  countdown = setInterval(() => {
    remainingTime--;
    document.getElementById('timerDisplay').innerText = `남은 시간: ${remainingTime}초`;

    let percent = (remainingTime / totalTime) * 100;
    document.getElementById('progressBar').style.width = percent + "%";

    if (percent <= 50 && percent > 20) {
      document.getElementById('progressBar').style.background = "orange";
    } else if (percent <= 20) {
      document.getElementById('progressBar').style.background = "red";
    }

    if (remainingTime <= 0) {
      clearInterval(countdown);
      document.getElementById('popupOverlay').style.display = 'flex';
    }
  }, 1000);
}

function restartChallenge() {
  document.getElementById('popupOverlay').style.display = 'none';
  document.getElementById('challengeArea').style.display = 'none';
  document.getElementById('timerDisplay').innerText = '';
}

function calculateCorrectSurvivors() {
  correctSurvivors = [];
  const bacteriaItems = document.querySelectorAll('#bacteriaListUI li');
  
  bacteriaItems.forEach((item, idx) => {
    const genesText = item.textContent.match(/\[(.*?)\]/)[1];
    const genes = genesText.split(',').map(g => g.trim());
    let survives = true;
    for (let drug in antibioticsData) {
      const req = antibioticsData[drug];
      if (!req.every(r => genes.includes(r))) {
        survives = false;
        break;
      }
    }
    if (survives) correctSurvivors.push(idx+1);
  });
}

function checkAnswer() {
  clearInterval(countdown);

  const userInput = document.getElementById('userAnswer').value.trim();
  const userArray = userInput.split(',').map(n => parseInt(n.trim())).filter(Boolean);

  if (JSON.stringify(userArray.sort()) === JSON.stringify(correctSurvivors.sort())) {
    document.getElementById('answerResult').innerHTML = `<span class="answer-correct">정답입니다! 🎉</span>`;
  } else {
    document.getElementById('answerResult').innerHTML = `<span class="answer-wrong">오답입니다. 😢 정답: ${correctSurvivors.join(', ')}</span>`;
  }

  document.getElementById('retryButtonArea').innerHTML = `<button onclick="startChallenge()">다시 도전하기</button>`;
}

updateDifficultyInfo();
</script>

</body>
</html>
